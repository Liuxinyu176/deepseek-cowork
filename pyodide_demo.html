<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Smart File Assistant - Pyodide Demo</title>
    <!-- 引入 Pyodide CDN -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
        #output { background: #f0f0f0; padding: 1rem; border-radius: 4px; white-space: pre-wrap; height: 200px; overflow-y: auto; }
        button { padding: 0.5rem 1rem; cursor: pointer; }
        .loading { color: #666; font-style: italic; }
    </style>
</head>
<body>
    <h1>Pyodide Zero-Dependency Demo</h1>
    <p>此页面演示如何在浏览器中直接运行 Python 代码，无需用户安装任何环境。</p>
    
    <div id="status" class="loading">正在加载 Python 环境 (WASM)...</div>
    
    <h3>1. 运行简单 Python 代码</h3>
    <textarea id="code" rows="5" style="width: 100%">
import sys
print(f"Hello from Python {sys.version}!")
print("计算 100 的阶乘:")
import math
print(math.factorial(100))
    </textarea>
    <br><br>
    <button onclick="runPython()" id="runBtn" disabled>运行代码</button>

    <h3>2. 模拟文件处理 (使用 Pandas)</h3>
    <p>点击下方按钮，Agent 将在内存中创建一个 CSV，用 Pandas 读取并转换为 JSON。</p>
    <button onclick="runPandasDemo()" id="pandasBtn" disabled>运行 Pandas 示例</button>

    <h3>输出日志</h3>
    <div id="output"></div>

    <script>
        let pyodide;

        // 捕获 Python 的标准输出
        function log(text) {
            const output = document.getElementById("output");
            output.textContent += text + "\n";
            output.scrollTop = output.scrollHeight;
        }

        async function init() {
            try {
                pyodide = await loadPyodide({
                    stdout: log,
                    stderr: log
                });
                document.getElementById("status").textContent = "Python 环境已就绪！";
                document.getElementById("status").style.color = "green";
                document.getElementById("runBtn").disabled = false;
                document.getElementById("pandasBtn").disabled = false;
                log("System: Pyodide loaded successfully.");
            } catch (err) {
                document.getElementById("status").textContent = "加载失败: " + err.message;
            }
        }

        async function runPython() {
            const code = document.getElementById("code").value;
            log(">>> Running code...");
            try {
                await pyodide.runPythonAsync(code);
                log("<<< Done.");
            } catch (err) {
                log("Error: " + err);
            }
        }

        async function runPandasDemo() {
            log(">>> Loading pandas (this may take a moment)...");
            document.getElementById("pandasBtn").disabled = true;
            
            try {
                // 1. 加载 micropip 包管理器
                await pyodide.loadPackage("micropip");
                const micropip = pyodide.pyimport("micropip");
                
                // 2. 安装 pandas
                await micropip.install("pandas");
                log("System: Pandas installed.");

                // 3. 执行数据处理脚本
                const script = `
import pandas as pd
import io

# 模拟创建一个 CSV 文件
csv_content = """name,age,city
Alice,30,New York
Bob,25,Los Angeles
Charlie,35,Chicago"""

print("1. 创建虚拟 CSV 文件...")
# 在内存中处理，实际场景中这里会是从 JS 传来的文件内容
df = pd.read_csv(io.StringIO(csv_content))

print("2. 读取 DataFrame:")
print(df)

print("3. 增加一列 'age_next_year':")
df['age_next_year'] = df['age'] + 1
print(df)

print("4. 转换为 JSON 返回:")
json_result = df.to_json(orient="records")
json_result
`;
                const result = await pyodide.runPythonAsync(script);
                log("Result from Python: " + result);
                
            } catch (err) {
                log("Error: " + err);
            } finally {
                document.getElementById("pandasBtn").disabled = false;
            }
        }

        init();
    </script>
</body>
</html>
