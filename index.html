<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>DeepSeek Cowork</title>
    <!-- 使用本地或 CDN Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; display: flex; height: 100vh; background-color: #f3f3f3; }
        .sidebar { width: 250px; background-color: #2c3e50; color: white; padding: 1rem; display: flex; flex-direction: column; }
        .main-content { flex: 1; padding: 2rem; display: flex; flex-direction: column; gap: 1rem; overflow-y: auto; }
        .card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #2c3e50; }
        textarea { width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; resize: vertical; font-family: monospace; }
        button { background-color: #3498db; color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 4px; cursor: pointer; font-size: 1rem; margin-top: 0.5rem; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #2980b9; }
        #log-area { background-color: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 4px; height: 200px; overflow-y: auto; font-family: 'Consolas', monospace; white-space: pre-wrap; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background-color: #ccc; margin-right: 8px; }
        .status-ready { background-color: #2ecc71; }
        .status-loading { background-color: #f1c40f; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h3>Smart Assistant</h3>
        <p>Your AI-powered file processing companion.</p>
        <div style="margin-top: auto; font-size: 0.8rem; opacity: 0.7;">
            Environment: Electron<br>
            Python: WASM (Pyodide)
        </div>
    </div>

    <div class="main-content">
        <div class="card">
            <h2><span id="status-dot" class="status-indicator status-loading"></span>Python Runtime Status</h2>
            <div id="status-text">Initializing Pyodide Environment...</div>
        </div>

        <div class="card">
            <h2>Task Input</h2>
            <p>Describe your task (e.g., "Create a sales report CSV and convert it to JSON")</p>
            <textarea id="user-input" rows="3" placeholder="Enter your command here...">Create a dummy CSV with 5 rows of sales data and convert it to JSON.</textarea>
            <button id="run-btn" onclick="executeTask()" disabled>Execute Task</button>
        </div>

        <div class="card" style="flex: 1;">
            <h2>Execution Log</h2>
            <div id="log-area"></div>
        </div>
    </div>

    <script>
        let pyodide;

        function log(message) {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString();
            logArea.textContent += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        async function initPyodide() {
            try {
                log("System: Loading Pyodide...");
                pyodide = await loadPyodide({
                    stdout: (text) => log("Python Output: " + text),
                    stderr: (text) => log("Python Error: " + text)
                });
                
                log("System: Loading micropip...");
                await pyodide.loadPackage("micropip");
                const micropip = pyodide.pyimport("micropip");
                
                log("System: Installing pandas...");
                await micropip.install("pandas");
                
                document.getElementById('status-dot').className = "status-indicator status-ready";
                document.getElementById('status-text').textContent = "Ready (Pandas Installed)";
                document.getElementById('run-btn').disabled = false;
                log("System: Environment Ready.");
            } catch (err) {
                log("System Error: " + err.message);
                document.getElementById('status-text').textContent = "Initialization Failed";
            }
        }

        async function executeTask() {
            const btn = document.getElementById('run-btn');
            btn.disabled = true;
            log("--- Task Started ---");

            // 模拟 LLM 生成代码的过程 (这里直接硬编码演示代码)
            const demoCode = `
import pandas as pd
import random
import json

print("Step 1: Generating dummy data...")
data = {
    'Date': pd.date_range(start='2024-01-01', periods=5),
    'Product': ['Widget A', 'Widget B', 'Widget A', 'Widget C', 'Widget B'],
    'Amount': [random.randint(100, 500) for _ in range(5)]
}
df = pd.DataFrame(data)

print("Step 2: DataFrame created:")
print(df)

print("Step 3: Converting to JSON...")
json_str = df.to_json(orient='records', date_format='iso')
json_str
`;

            try {
                log("Agent: Generating Python code...");
                await new Promise(r => setTimeout(r, 1000)); // 模拟思考延迟
                log("Agent: Executing code...");
                
                const result = await pyodide.runPythonAsync(demoCode);
                
                log("Result: " + result);
                
                // 演示调用 Electron API 保存文件
                if (window.electronAPI) {
                    log("Agent: Saving result to Downloads folder...");
                    const saveResult = await window.electronAPI.saveFile('sales_data.json', result);
                    if (saveResult.success) {
                        log(`System: File saved successfully at ${saveResult.path}`);
                    } else {
                        log(`System Error: Failed to save file - ${saveResult.error}`);
                    }
                } else {
                    log("System Warning: Electron API not available (Running in browser mode?)");
                }

            } catch (err) {
                log("Execution Error: " + err.message);
            } finally {
                btn.disabled = false;
                log("--- Task Finished ---");
            }
        }

        // Initialize on load
        initPyodide();
    </script>
</body>
</html>
